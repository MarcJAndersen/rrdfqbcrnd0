<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="mja@statgroup.dk" />

<meta name="date" content="2015-01-17" />

<title>Derive results in RDF data cube and compare with results in data cube</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css,body%20%7B%0A%20%20background%2Dcolor%3A%20%23fff%3B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20max%2Dwidth%3A%20700px%3B%0A%20%20overflow%3A%20visible%3B%0A%20%20padding%2Dleft%3A%202em%3B%0A%20%20padding%2Dright%3A%202em%3B%0A%20%20font%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20font%2Dsize%3A%2014px%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%7D%0A%0A%23header%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%23TOC%20%7B%0A%20%20clear%3A%20both%3B%0A%20%20margin%3A%200%200%2010px%2010px%3B%0A%20%20padding%3A%204px%3B%0A%20%20width%3A%20400px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20border%2Dradius%3A%205px%3B%0A%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20font%2Dsize%3A%2013px%3B%0A%20%20line%2Dheight%3A%201%2E3%3B%0A%7D%0A%20%20%23TOC%20%2Etoctitle%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%20%20margin%2Dleft%3A%205px%3B%0A%20%20%7D%0A%0A%20%20%23TOC%20ul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2040px%3B%0A%20%20%20%20margin%2Dleft%3A%20%2D1%2E5em%3B%0A%20%20%20%20margin%2Dtop%3A%205px%3B%0A%20%20%20%20margin%2Dbottom%3A%205px%3B%0A%20%20%7D%0A%20%20%23TOC%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dleft%3A%20%2D2em%3B%0A%20%20%7D%0A%20%20%23TOC%20li%20%7B%0A%20%20%20%20line%2Dheight%3A%2016px%3B%0A%20%20%7D%0A%0Atable%20%7B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dcolor%3A%20%23DDDDDD%3B%0A%20%20border%2Dstyle%3A%20outset%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0A%20%20border%2Dwidth%3A%202px%3B%0A%20%20padding%3A%205px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%20%20line%2Dheight%3A%2018px%3B%0A%20%20padding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0A%20%20border%2Dleft%2Dstyle%3A%20none%3B%0A%20%20border%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%2E5em%200%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20padding%3A%200%2E25em%200%2E75em%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20border%2Dstyle%3A%20solid%3B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23777%3B%0A%20%20margin%3A%2028px%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dleft%3A%200%3B%0A%7D%0A%20%20dl%20dd%20%7B%0A%20%20%20%20margin%2Dbottom%3A%2013px%3B%0A%20%20%20%20margin%2Dleft%3A%2013px%3B%0A%20%20%7D%0A%20%20dl%20dt%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%7D%0A%0Aul%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%7D%0A%20%20ul%20li%20%7B%0A%20%20%20%20list%2Dstyle%3A%20circle%20outside%3B%0A%20%20%7D%0A%20%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dbottom%3A%200%3B%0A%20%20%7D%0A%0Apre%2C%20code%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20color%3A%20%23333%3B%0A%7D%0Apre%20%7B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%20%20%20%20%2F%2A%20Wrap%20long%20lines%20%2A%2F%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20margin%3A%205px%200px%2010px%200px%3B%0A%20%20padding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0A%20%20padding%3A%202px%200px%3B%0A%7D%0A%0Adiv%2Efigure%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0A%20%20background%2Dcolor%3A%20%23FFFFFF%3B%0A%20%20padding%3A%202px%3B%0A%20%20border%3A%201px%20solid%20%23DDDDDD%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20margin%3A%200%205px%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%20%20font%2Dsize%3A%2035px%3B%0A%20%20line%2Dheight%3A%2040px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20border%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20padding%2Dbottom%3A%202px%3B%0A%20%20font%2Dsize%3A%20145%25%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20border%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20font%2Dsize%3A%20120%25%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0A%20%20margin%2Dleft%3A%208px%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Ah5%2C%20h6%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ccc%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230033dd%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%236666ff%3B%20%7D%0A%20%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%23800080%3B%20%7D%0A%20%20a%3Avisited%3Ahover%20%7B%0A%20%20%20%20color%3A%20%23BB00BB%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%0A%2F%2A%20Class%20described%20in%20https%3A%2F%2Fbenjeffrey%2Ecom%2Fposts%2Fpandoc%2Dsyntax%2Dhighlighting%2Dcss%0A%20%20%20Colours%20from%20https%3A%2F%2Fgist%2Egithub%2Ecom%2Frobsimmons%2F1172277%20%2A%2F%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Keyword%20%2A%2F%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%2F%2A%20DataType%20%2A%2F%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%2F%2A%20DecVal%20%28decimal%20values%29%20%2A%2F%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20BaseN%20%2A%2F%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Float%20%2A%2F%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Char%20%2A%2F%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20String%20%2A%2F%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%2F%2A%20Comment%20%2A%2F%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%2F%2A%20OtherToken%20%2A%2F%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20AlertToken%20%2A%2F%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Function%20calls%20%2A%2F%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%2F%2A%20ErrorTok%20%2A%2F%0A%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">Derive results in RDF data cube and compare with results in data cube</h1>
<h4 class="author"><em><a href="mailto:mja@statgroup.dk">mja@statgroup.dk</a></em></h4>
<h4 class="date"><em>2015-01-17</em></h4>
</div>


<div id="for-developing" class="section level3">
<h3>For developing</h3>
<p>Use</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(knitr)
<span class="kw">knit</span>(<span class="st">&quot;vignettes/check-cube.Rmd&quot;</span>)</code></pre>
</div>
<div id="the-vignette" class="section level3">
<h3>The vignette</h3>
<p>The code below is currently not evaluated, as downloading the datasets from Google Code may not work.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">width=</span><span class="dv">200</span>) <span class="co"># long lines</span>

<span class="kw">library</span>(xlsx)
<span class="kw">library</span>(foreign)
<span class="kw">library</span>(RCurl)

<span class="kw">library</span>(rrdf)
<span class="kw">library</span>(rrdfqbcrnd0)

debug.add.data.triple&lt;-<span class="st"> </span>function( cubeData,
subject,
predicate,
data, type) {

<span class="kw">print</span>(<span class="kw">cbind</span>(<span class="dt">subject=</span>subject,<span class="dt">predicate=</span>predicate,<span class="dt">data=</span>data,<span class="dt">type=</span>type))
      
<span class="kw">add.data.triple</span>( cubeData,
<span class="dt">subject=</span>subject,
<span class="dt">predicate=</span>predicate,
<span class="dt">data=</span>data, <span class="dt">type=</span>type)

} 
 
check.cube&lt;-<span class="st"> </span>function(
  <span class="dt">obsFile=</span><span class="kw">paste</span>(<span class="kw">tempdir</span>(),<span class="st">&quot;/&quot;</span>, <span class="st">&quot;adsl&quot;</span>, <span class="st">&quot;.xpt&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),
  <span class="dt">dsURL=</span> <span class="st">&quot;https://phuse-scripts.googlecode.com/svn/trunk/scriptathon2014/data/adsl.xpt&quot;</span>,
  <span class="dt">ds.dataset=</span> <span class="st">&quot;ds:dataset-demog&quot;</span>,
  <span class="dt">qbfiledir=</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata/sample-rdf&quot;</span>, <span class="dt">package=</span><span class="st">&quot;rrdfqbcrnd0&quot;</span>),
  <span class="dt">qbfile=</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata/sample-rdf&quot;</span>, <span class="st">&quot;DC-DM-sample.TTL&quot;</span>, <span class="dt">package=</span><span class="st">&quot;rrdfqbcrnd0&quot;</span>),
  <span class="dt">domainName=</span><span class="st">&quot;demog&quot;</span>,
  <span class="dt">RDFCubeWorkbook =</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata/sample-cfg&quot;</span>, <span class="st">&quot;RDFCubeWorkbook.xlsx&quot;</span>, <span class="dt">package=</span><span class="st">&quot;rrdfqbcrnd0&quot;</span>)
) {

 ## obsFile=paste(tempdir(),&quot;/&quot;, &quot;adsl&quot;, &quot;.xpt&quot;,sep=&quot;&quot;)
 ## dsURL= NULL
 ## ds.dataset= &quot;ds:dataset-demog&quot;
 ## qbfiledir= system.file(&quot;extdata/sample-rdf&quot;, package=&quot;rrdfqbcrnd0&quot;)
 ## qbfile= system.file(&quot;extdata/sample-rdf&quot;, &quot;DC-DM-sample.TTL&quot;, package=&quot;rrdfqbcrnd0&quot;)
 ## domainName=&quot;demog&quot;
 ## RDFCubeWorkbook = NULL

if (!<span class="kw">is.null</span>(RDFCubeWorkbook)) {
  common.prefixes &lt;-<span class="st"> </span><span class="kw">read.xlsx</span>(RDFCubeWorkbook,<span class="dt">sheetName=</span><span class="kw">paste0</span>(<span class="st">&quot;CubePrefixes&quot;</span>))
  cubeMetadata &lt;-<span class="st"> </span><span class="kw">read.xlsx</span>(RDFCubeWorkbook,<span class="dt">sheetName=</span><span class="kw">paste0</span>(domainName,<span class="st">&quot;-Components&quot;</span>))
  metadataSource &lt;-cubeMetadata[<span class="kw">grep</span>(<span class="st">&quot;metadata&quot;</span>, cubeMetadata$compType),]
  if (<span class="kw">is.null</span>(obsFile)) {
    obsFile&lt;-<span class="st"> </span>metadataSource[ metadataSource$compName==<span class="st">&quot;wasDerivedFrom&quot;</span>, <span class="st">&quot;compLabel&quot;</span> ]
  }
  if (<span class="kw">is.null</span>(qbfile)) {
    qbfile&lt;-<span class="st">  </span><span class="kw">file.path</span>(qbfiledir,metadataSource[ metadataSource$compName==<span class="st">&quot;dataCubeFileName&quot;</span>, <span class="st">&quot;dataCubeFileName&quot;</span>] ) 
  }
  if (<span class="kw">is.null</span>(dsURL)) {
    dsURL&lt;-<span class="st">  </span>metadataSource[ metadataSource$compName==<span class="st">&quot;obsURL&quot;</span>, <span class="st">&quot;dataCubeFileName&quot;</span> ]
  }
} else {
  common.prefixes &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
    <span class="dt">prefix=</span><span class="kw">gsub</span>(<span class="st">&quot;^prefix&quot;</span>,<span class="st">&quot;&quot;</span>,<span class="kw">names</span>(<span class="kw">Get.default.crnd.prefixes</span>())),
    <span class="dt">namespace=</span><span class="kw">as.character</span>(<span class="kw">Get.default.crnd.prefixes</span>() )
    )
}  


if (!<span class="st"> </span><span class="kw">is.null</span>(dsURL) ) {
   if (!<span class="st"> </span><span class="kw">url.exists</span>(dsURL) ) {
      <span class="kw">stop</span>(<span class="kw">paste0</span>(<span class="st">&quot;Can not access URL &quot;</span>,dsURL))
   }
   <span class="kw">download.file</span>( dsURL, obsFile, <span class="dt">method=</span><span class="st">&quot;curl&quot;</span>)
}

if (!<span class="st"> </span><span class="kw">file.exists</span>(obsFile)) {
  <span class="kw">stop</span>(<span class="kw">paste0</span>(<span class="st">&quot;Expected file &quot;</span>, obsFile, <span class="st">&quot; does not exist&quot;</span>))
  }
DataSet&lt;-<span class="kw">read.xport</span>(obsFile)

## library(Hmisc)
## DataSet &lt;- sasxport.get(fnDataSet)
## # --- see what have got:
## contents(DataSet)
## label(DataSet)

<span class="co"># str(DataSet)</span>



<span class="co"># Domain-specific prefixes:for /code/, /prop/, /dccs/ and /dataset/</span>
custom.prefixes &lt;-<span class="kw">Get.qb.crnd.prefixes</span>(domainName)

<span class="co"># Prefix for storing the results of check each measure in the data cube</span>

  validation.mesure.prefix&lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">prefix=</span><span class="kw">c</span>(<span class="st">&quot;validmeas&quot;</span>),
        <span class="dt">namespace=</span><span class="kw">c</span>(<span class="kw">paste0</span>(<span class="st">&quot;http://www.example.org/dc/&quot;</span>,domainName,<span class="st">&quot;/validmeas/&quot;</span>)
                            ))

prefixes&lt;-<span class="st"> </span><span class="kw">rbind</span>(common.prefixes, custom.prefixes, validation.mesure.prefix)

forsparqlprefix&lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;prefix&quot;</span>, <span class="kw">paste</span>(prefixes$prefix,<span class="st">&quot;:&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="kw">paste</span>(<span class="st">&quot;&lt;&quot;</span>,prefixes$namespace,<span class="st">&quot;&gt;&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),<span class="dt">sep=</span><span class="st">&quot; &quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)

<span class="co"># cat(forsparqlprefix)</span>
<span class="co"># The qbfile also contains prefixes, which are part of the model</span>
<span class="co"># So not adding the prefixes to the model, but using them for adding further</span>
<span class="co"># information to the model when deriving statistics</span>

cubeData =<span class="st"> </span><span class="kw">new.rdf</span>(<span class="dt">ontology=</span><span class="ot">FALSE</span>)
myprefixes&lt;-<span class="st"> </span><span class="kw">qb.def.prefixlist</span>(cubeData, prefixes )
<span class="kw">load.rdf</span>( qbfile, <span class="dt">format=</span><span class="st">&quot;N3&quot;</span>, <span class="dt">appendTo=</span> cubeData)
<span class="co"># summarize.rdf(cubeData)</span>


## ------------------------------------------------------------------------
cube.observations1&lt;-<span class="st"> </span><span class="kw">sparql.rdf</span>(cubeData,
   <span class="kw">paste</span>( forsparqlprefix,
     <span class="st">&quot;select * where {?s ?p ?o .} limit 10&quot;</span>
     )
   );
<span class="co"># print(cube.observations1)</span>


cube.observations2&lt;-<span class="st"> </span><span class="kw">sparql.rdf</span>(cubeData,
   <span class="kw">paste</span>( forsparqlprefix,
     <span class="st">&quot;select * where { ?s a qb:Observation ; ?p ?o .} limit 10&quot;</span>
     )
   );
<span class="co"># print(cube.observations2)</span>

## get the dimensions
cube.dimensions&lt;-<span class="st"> </span><span class="kw">sparql.rdf</span>(cubeData,
  <span class="kw">paste</span>(forsparqlprefix,
<span class="st">&quot;select * where { [] qb:dimension ?p .  }&quot;</span>
));
<span class="co"># print(cube.dimensions)</span>

## get the codelist
codelists.rq&lt;-<span class="st">   </span><span class="kw">paste</span>(forsparqlprefix,
<span class="st">'</span>
<span class="st">select ?p ?cl ?prefLabel where {</span>
<span class="st">[] qb:dimension ?p.</span>
<span class="st">?p qb:codeList ?c.</span>
<span class="st">?c skos:hasTopConcept ?cl .</span>
<span class="st">?cl skos:prefLabel ?prefLabel.</span>
<span class="st">}</span>
<span class="st">'</span>
)

<span class="co"># cat(codelists.rq)</span>

cube.codelists&lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">sparql.rdf</span>(cubeData, codelists.rq));
<span class="co"># print(cube.codelists)</span>


codelist.all&lt;-<span class="st"> </span>cube.codelists[ cube.codelists$prefLabel==<span class="st">&quot;_ALL_&quot;</span>,]
<span class="co"># print(codelist.all)</span>
subsetting.dimensions&lt;-<span class="st"> </span><span class="kw">list</span>();

<span class="co"># the variable name/column name in the data frame should be part of the datacube</span>
<span class="co"># this would remove the need for the workaround below using gsub</span>
for (i in <span class="dv">1</span>:<span class="kw">nrow</span>(codelist.all))
{
  subsetting.dimensions[[ <span class="kw">gsub</span>(<span class="st">&quot;[^:]*:&quot;</span>,<span class="st">&quot;&quot;</span>, codelist.all[i,<span class="st">&quot;p&quot;</span>]) ]] &lt;-
<span class="st">      </span><span class="kw">as.character</span>(codelist.all[i,<span class="st">&quot;cl&quot;</span>])
}


## get the dimensions and attributes

cube.dimensionsattr&lt;-<span class="st"> </span><span class="kw">sparql.rdf</span>(cubeData,
  <span class="kw">paste</span>(forsparqlprefix,
<span class="st">&quot;select * where { {[] qb:dimension ?p . } union {  ?p a qb:AttributeProperty . } }&quot;</span>
));
<span class="co"># print(cube.dimensionsattr)</span>

selectexpr&lt;-<span class="st">  </span><span class="kw">paste</span>(  <span class="st">&quot;select * where {&quot;</span>,
    <span class="st">&quot;    ?s a qb:Observation  ;&quot;</span>,
    <span class="kw">paste</span>(<span class="st">&quot;       qb:dataSet&quot;</span>,  ds.dataset, <span class="st">&quot; ;&quot;</span>, <span class="dt">sep=</span><span class="st">&quot; &quot;</span>, <span class="dt">collapse=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,
    <span class="kw">paste0</span>( cube.dimensionsattr, <span class="st">&quot; &quot;</span>, <span class="kw">sub</span>(<span class="st">&quot;prop:&quot;</span>, <span class="st">&quot;?&quot;</span>, cube.dimensionsattr), <span class="st">&quot;;&quot;</span>, <span class="dt">collapse=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>),
                    <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,
    <span class="st">&quot;       prop:measure      ?measure ;      </span><span class="ch">\n</span><span class="st">&quot;</span>,
    <span class="st">&quot;       prop:denominator      ?denominator .     </span><span class="ch">\n</span><span class="st">&quot;</span>,
    <span class="kw">paste0</span>( <span class="st">&quot;optional{ &quot;</span>, <span class="kw">sub</span>(<span class="st">&quot;prop:&quot;</span>, <span class="st">&quot;?&quot;</span>, cube.dimensionsattr), <span class="st">&quot; &quot;</span>,
           <span class="st">&quot;skos:prefLabel&quot;</span>,
           <span class="st">&quot; &quot;</span>,
           <span class="kw">sub</span>(<span class="st">&quot;prop:&quot;</span>, <span class="st">&quot;?&quot;</span>, cube.dimensionsattr), <span class="st">&quot;value&quot;</span> ,
           <span class="st">&quot; . &quot;</span>, <span class="st">&quot;}&quot;</span>,
           <span class="dt">collapse=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>),
    <span class="st">&quot;} &quot;</span>,
    <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>
   );
<span class="co"># cat(selectexpr)</span>
<span class="co"># cat(  paste(forsparqlprefix, &quot;\n&quot;, selectexpr ) )</span>

cube.observations&lt;-<span class="st"> </span><span class="kw">sparql.rdf</span>(cubeData,
  <span class="kw">paste</span>(forsparqlprefix, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,  selectexpr )
  );

<span class="co"># print(head(cube.observations))</span>
<span class="co"># str(cube.observations)</span>


<span class="co"># cts:cdiscSubmissionValue could also be used instead of skos:prefLabel</span>
<span class="co"># by code:saffl-Y does not have cts:cdiscSubmissionValue</span>

<span class="co"># using list for key-value lookup to function for descriptive statistic</span>
univfunc1=<span class="st"> </span><span class="kw">list</span>(
  <span class="st">&quot;code:procedure-MEAN&quot;</span>=mean,
  <span class="st">&quot;code:procedure-STDDEV&quot;</span>=sd,
  <span class="st">&quot;code:procedure-MEDIAN&quot;</span>=median,
  <span class="st">&quot;code:procedure-MIN&quot;</span>=min,
  <span class="st">&quot;code:procedure-MAX&quot;</span>=max
  )

univfunc2=<span class="st"> </span><span class="kw">list</span>(
  <span class="st">&quot;code:procedure-COUNT&quot;</span>=length,
  <span class="st">&quot;code:procedure-COUNTDISTINCT&quot;</span>=function(x){<span class="kw">length</span>(<span class="kw">unique</span>(x))}
  )


for (r in  <span class="dv">1</span>:<span class="kw">nrow</span>(cube.observations )  ) {
thisrow&lt;-<span class="st">  </span>cube.observations[r,]
<span class="co"># print(thisrow)</span>

data.subset.logical=<span class="st"> </span><span class="kw">rep</span>(<span class="ot">TRUE</span>, <span class="kw">nrow</span>(DataSet))
for (v in <span class="kw">names</span>(subsetting.dimensions)) {
<span class="co">#   print( c(v, thisrow[v ],  subsetting.dimensions[[ v ]] ) )</span>
  if ( thisrow[v ] !=<span class="st"> </span>subsetting.dimensions[[ v ]] ) {
<span class="co">#   print( paste0(v, &quot;: &quot;, thisrow[v ], &quot; = &quot;, thisrow[ paste0(v,&quot;value&quot;) ]))</span>
<span class="co">#   print( DataSet[,toupper(v)] == thisrow[ paste0(v,&quot;value&quot;) ] )</span>
    data.subset.logical=<span class="st"> </span>data.subset.logical &amp;<span class="st"> </span>( DataSet[,<span class="kw">toupper</span>(v)] ==<span class="st"> </span>thisrow[ <span class="kw">paste0</span>(v,<span class="st">&quot;value&quot;</span>) ] )
  }
}


has.result=<span class="st"> </span><span class="ot">FALSE</span>

if (thisrow[<span class="st">&quot;procedure&quot;</span>] %in%<span class="st"> </span><span class="kw">names</span>(univfunc1) ) {
<span class="co"># print(&quot;univfunc1&quot;)</span>
  AOD=<span class="st"> </span>DataSet[data.subset.logical,thisrow[<span class="st">&quot;factorvalue&quot;</span>]]
  result=<span class="st"> </span>univfunc1[[ thisrow[<span class="st">&quot;procedure&quot;</span>] ]](AOD)
  has.result=<span class="st"> </span><span class="ot">TRUE</span>
<span class="co">#   print(paste(&quot;AOD number of observations&quot;, nrow(AOD)))</span>
} else if (thisrow[<span class="st">&quot;procedure&quot;</span>] %in%<span class="st"> </span><span class="kw">names</span>(univfunc2) ) {
<span class="co"># print(paste0(&quot;univfunc2&quot;,&quot; &quot;,thisrow[&quot;procedure&quot; ],collapse=&quot; &quot;))</span>
  AOD=<span class="st"> </span>DataSet[data.subset.logical,<span class="st">&quot;USUBJID&quot;</span>]  <span class="co"># take the first variable, would be better if there was a default, like USUBJID</span>
  result=<span class="st"> </span>univfunc2[[ thisrow[<span class="st">&quot;procedure&quot;</span> ] ]](AOD)
  has.result=<span class="st"> </span><span class="ot">TRUE</span>
<span class="co">#   print(paste0(&quot;AOD number of observations&quot;, nrow(AOD), sep=&quot; &quot;))</span>
} else if (thisrow[<span class="st">&quot;procedure&quot;</span>]==<span class="st"> &quot;code:procedure-PERCENT&quot;</span> &amp;<span class="st"> </span>thisrow[<span class="st">&quot;factor&quot;</span>]==<span class="st"> &quot;code:factor-PROPORTION&quot;</span>) {

<span class="co">#  print(c(&quot;proportion&quot;,thisrow[&quot;denominator&quot;]))</span>

<span class="co">#  denom.def&lt;- thisrow[ c(&quot;saffl&quot;, &quot;trt01a&quot;, &quot;race&quot;, &quot;sex&quot; ) ]</span>
<span class="co">#  denom.def&lt;- thisrow[ c( &quot;trt01a&quot;, &quot;race&quot;, &quot;sex&quot; ) ]</span>
  denom.def&lt;-<span class="st"> </span>thisrow[ <span class="kw">names</span>(subsetting.dimensions) ]

  denom.def[ <span class="kw">tolower</span>(thisrow[<span class="st">&quot;denominator&quot;</span>]) ] =<span class="kw">paste0</span>(<span class="st">&quot;code:&quot;</span>,<span class="kw">tolower</span>(thisrow[<span class="st">&quot;denominator&quot;</span>]),<span class="st">&quot;-_ALL_&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)
  AOD=<span class="st"> </span>DataSet[data.subset.logical,] <span class="co"># should use a variable name - USUBJID like for count</span>

denom.data.subset.logical=<span class="st"> </span><span class="kw">rep</span>(<span class="ot">TRUE</span>, <span class="kw">nrow</span>(DataSet))
<span class="co"># print( denom.def )</span>
for (v in <span class="kw">names</span>(denom.def)) {
  if ( denom.def[v ] !=<span class="st"> </span>subsetting.dimensions[[ v ]] ) {
    denom.data.subset.logical=<span class="st"> </span>denom.data.subset.logical &amp;<span class="st"> </span>( DataSet[,<span class="kw">toupper</span>(v)] ==<span class="st"> </span>thisrow[ <span class="kw">paste0</span>(v,<span class="st">&quot;value&quot;</span>) ] )
  }
}
  denom.data.frame&lt;-<span class="st">  </span>DataSet[denom.data.subset.logical , ]

  result=<span class="st"> </span><span class="kw">nrow</span>(AOD) /<span class="st"> </span><span class="kw">nrow</span>( denom.data.frame ) *<span class="st"> </span><span class="dv">100</span>;
  has.result=<span class="ot">TRUE</span>
  <span class="co"># print(paste(&quot;AOD number of observations&quot;, nrow(AOD)))</span>
  <span class="co"># print(paste(&quot;denom.data.frame number of observations&quot;, nrow(denom.data.frame)))</span>
}



if (has.result) {
<span class="co"># print(paste(&quot;result&quot;, result, sep=&quot; &quot;))</span>
<span class="kw">add.data.triple</span>( cubeData,
<span class="dt">subject=</span><span class="kw">gsub</span>(<span class="st">&quot;ds:&quot;</span>, myprefixes$prefixDS, thisrow[<span class="st">&quot;s&quot;</span>]), <span class="co"># add triple does not resolve prefix</span>
<span class="dt">predicate=</span><span class="kw">gsub</span>(<span class="st">&quot;validmeas:&quot;</span>, myprefixes$prefixVALIDMEAS, <span class="st">&quot;validmeas:result&quot;</span>),
<span class="dt">data=</span><span class="kw">paste</span>(result), <span class="dt">type=</span><span class="st">&quot;float&quot;</span>)
} else {
<span class="co">#  print( paste( thisrow[&quot;s&quot;], ifelse(has.result, result, &quot;No result determined&quot;) ) )</span>
}


} <span class="co"># for</span>

cube.measure.result&lt;-<span class="st">  </span><span class="kw">sparql.rdf</span>(cubeData,
  <span class="kw">paste</span>(forsparqlprefix,
    <span class="st">&quot;select * where {&quot;</span>,
    <span class="st">&quot;    ?s a qb:Observation  ;&quot;</span>,
    <span class="kw">paste</span>(<span class="st">&quot;       qb:dataSet&quot;</span>,  ds.dataset, <span class="st">&quot; ;&quot;</span>, <span class="dt">sep=</span><span class="st">&quot; &quot;</span>, <span class="dt">collapse=</span><span class="st">&quot; &quot;</span>),
    <span class="st">&quot;       prop:measure      ?measure ;      &quot;</span>,
    <span class="st">&quot;      optional{ ?s validmeas:result      ?result }      &quot;</span>,
    <span class="st">&quot;} order by ?s&quot;</span>
                )
  );

<span class="co"># print(cube.measure.result)</span>


cube.check&lt;-<span class="st"> </span><span class="kw">sparql.rdf</span>(cubeData,
  <span class="kw">paste</span>(forsparqlprefix,
    <span class="st">&quot;select * where {&quot;</span>,
    <span class="st">&quot;    ?s a qb:Observation  ;&quot;</span>,
    <span class="kw">paste</span>(<span class="st">&quot;       qb:dataSet&quot;</span>,  ds.dataset, <span class="st">&quot; ;&quot;</span>, <span class="dt">sep=</span><span class="st">&quot; &quot;</span>, <span class="dt">collapse=</span><span class="st">&quot; &quot;</span>),
    <span class="st">&quot;       prop:measure      ?measure ;      &quot;</span>,
    <span class="st">&quot;      optional{ ?s validmeas:result      ?result }      &quot;</span>,
    <span class="st">&quot; filter ( ?measure != ?result ) &quot;</span>,
    <span class="st">&quot;} order by ?s&quot;</span>
                )
  );

<span class="kw">print</span>(<span class="st">&quot;If the result is &lt;0 x 0&gt; matrix then all value matches&quot;</span>)
cube.check


}



<span class="kw">check.cube</span>(
   <span class="dt">obsFile=</span><span class="kw">paste</span>(<span class="kw">tempdir</span>(),<span class="st">&quot;/&quot;</span>, <span class="st">&quot;adsl&quot;</span>, <span class="st">&quot;.xpt&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),
   <span class="dt">dsURL=</span> <span class="st">&quot;https://phuse-scripts.googlecode.com/svn/trunk/scriptathon2014/data/adsl.xpt&quot;</span>,
   <span class="dt">ds.dataset=</span> <span class="st">&quot;ds:dataset-demog&quot;</span>,
 <span class="dt">qbfile=</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata/sample-rdf&quot;</span>, <span class="st">&quot;DC-DM-sample.TTL&quot;</span>, <span class="dt">package=</span><span class="st">&quot;rrdfqbcrnd0&quot;</span>),
 <span class="dt">domain=</span><span class="st">&quot;demog&quot;</span>,
 <span class="dt">RDFCubeWorkbook=</span><span class="ot">NULL</span>
 )

<span class="kw">check.cube</span>(
<span class="dt">obsFile=</span><span class="kw">paste</span>(<span class="kw">tempdir</span>(),<span class="st">&quot;/&quot;</span>, <span class="st">&quot;adae&quot;</span>, <span class="st">&quot;.xpt&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),
<span class="dt">dsURL=</span> <span class="st">&quot;https://phuse-scripts.googlecode.com/svn/trunk/scriptathon2014/data/adae.xpt&quot;</span>,
<span class="dt">ds.dataset=</span> <span class="st">&quot;ds:dataset-ae&quot;</span>,
<span class="dt">qbfile=</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata/sample-rdf&quot;</span>, <span class="st">&quot;DC-AE-sample.TTL&quot;</span>, <span class="dt">package=</span><span class="st">&quot;rrdfqbcrnd0&quot;</span>),
<span class="dt">domain=</span><span class="st">&quot;ae&quot;</span>,
<span class="dt">RDFCubeWorkbook=</span><span class="ot">NULL</span>
)

<span class="kw">check.cube</span>(
  <span class="dt">obsFile=</span><span class="kw">paste</span>(<span class="kw">tempdir</span>(),<span class="st">&quot;/&quot;</span>, <span class="st">&quot;adsl&quot;</span>, <span class="st">&quot;.xpt&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),
  <span class="dt">dsURL=</span> <span class="ot">NULL</span>,
  <span class="dt">ds.dataset=</span> <span class="st">&quot;ds:dataset-demog&quot;</span>,
  <span class="dt">qbfile=</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata/sample-rdf&quot;</span>, <span class="st">&quot;DC-DM-sample.TTL&quot;</span>, <span class="dt">package=</span><span class="st">&quot;rrdfqbcrnd0&quot;</span>),
  <span class="dt">domain=</span><span class="st">&quot;demog&quot;</span>,
  <span class="dt">RDFCubeWorkbook=</span><span class="ot">NULL</span>
 )

<span class="kw">check.cube</span>(
 <span class="dt">obsFile=</span><span class="kw">paste</span>(<span class="kw">tempdir</span>(),<span class="st">&quot;/&quot;</span>, <span class="st">&quot;adae&quot;</span>, <span class="st">&quot;.xpt&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),
 <span class="dt">dsURL=</span>  <span class="ot">NULL</span>,
 <span class="dt">ds.dataset=</span> <span class="st">&quot;ds:dataset-ae&quot;</span>,
 <span class="dt">qbfile=</span> <span class="kw">system.file</span>(<span class="st">&quot;extdata/sample-rdf&quot;</span>, <span class="st">&quot;DC-AE-sample.TTL&quot;</span>, <span class="dt">package=</span><span class="st">&quot;rrdfqbcrnd0&quot;</span>),
 <span class="dt">domain=</span><span class="st">&quot;ae&quot;</span>,
 <span class="dt">RDFCubeWorkbook=</span><span class="ot">NULL</span>
 )</code></pre>
<p>End of file.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
