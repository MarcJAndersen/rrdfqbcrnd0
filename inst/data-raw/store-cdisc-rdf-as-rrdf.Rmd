---
title: "Store CDISC RDF as RRDF data model"
author: "PhuseSubTeamAnalysisResults@example.org"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Store CDISC RDF as RRDF data model}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---



## Prelimnaries

### Make local copy of the rdf.cdisc.org
Here is how to make a local copy of the rdf.cdisc.org - with Bash Shell on Linux.


```{r get-rdf-cdisc-org.sh, eval=FALSE, engine='bash'}
echo change below to suit your setup
export CDISCRDF_HOME=~/projects/phrmwg
echo only if directory does not exist 
mkdir -p ${CDISCRDF_HOME}  
cd ${CDISCRDF_HOME}

git clone https://github.com/phuse-org/rdf.cdisc.org.git

mkdir rdf-data-cube
cd rdf-data-cube
wget http://publishing-statistical-data.googlecode.com/svn/trunk/specs/src/main/vocab/cube.ttl
cd ..
```


### Make apache jena TDB store


```{r load-into-tdb.sh, eval=FALSE, engine='bash'}
mkdir tdb

export JENA_HOME=/opt/apache-jena-2.12.1
${JENA_HOME}/bin/tdbloader2 --loc tdb rdf.cdisc.org/*/*.{ttl,owl} rdf-data-cube/*.ttl 
```

### Start fuseki using TDB store

Start fuseki pointing to the TDB store created - note the update option makes it possible to upload triples as, say, turtle files.


```{r start-fuseki.sh, eval=FALSE, engine='bash'}
cd ${CDISCRDF_HOME}
export FUSEKI_HOME=/opt/jena-fuseki-1.1.1
${FUSEKI_HOME}/fuseki-server --pages=${FUSEKI_HOME}/pages --update --loc=tdb /cdisc
```


## Finding the files

Finding the files replace directory for find with the appropriate directory for your setup.
Also change below in R code.

```
find ~/projects/phrmwg/rdf.cdisc.org -name "*.rdf" -o -name "*.owl" -o -name "*.ttl"
```

```

## Create local version using RRDF from local directory conting rdf.cdisc.org

First load the files in a rrdf store.

```{r, results='asis', eval=TRUE}

# change as appropriate
# in my setup the phrmwg directory contains a git pull of rdf.cdisc.org

library(rrdf)
library(tools)

cdisc.save.zip<- Create.cdisc.standards.from.local()
cdisc.save.zip.info<- file.info(cdisc.save.zip)
message("File ", cdisc.save.zip, " created ", cdisc.save.zip.info$ctime, " size ", cdisc.save.zip.info$size, " bytes")
```


The code below shows the call for loading the zipped rdf file and store in triple store.
This is currently handled in the .onLoad function for the package. The rrdf model is then stored in the package environment.

```{r, results='asis', eval=TRUE}

cdisc.rdf<- Load.cdisc.standards()

# need more code to compare the two models ...

```


## Create local version using SPARQL

The code below does not work.

```{r, results='asis', eval=TRUE}

library (rrdf)
# library (RCurl)

# change as appropriate

URLstem<- "https://github.com/phuse-org/rdf.cdisc.org/raw/master"

SPARQLscript<- paste(
  "CONSTRUCT { ?s ?p ?o }",
paste0( "FROM ", "<", URLstem, "/", Get.filenames.for.cdisc.standards(), ">", collapse="\n" )
  ,
  "WHERE { ?s ?p ?o }", sep="\n", collapse="\n"
)

cat(SPARQLscript,"\n")
writeLines( SPARQLscript, con=file.path(system.file("extdata/CDISC-standards-rdf", package="rrdfqbcrnd0"), "get-rdf.disc.org.rq" ) )

```


The code below does not work with rrdf.

```{r, results='asis', eval=FALSE}
cdisc.rdf.store <- new.rdf(ontology=FALSE)
results <- construct.rdf(cdisc.rdf.store, SPARQLscript )
summarize.rdf(results)
```

But the generated SPARQL query works with arq:
```
export JENAROOT=/opt/apache-jena-2.12.1
export PATH=$PATH:$JENAROOT/bin
arq --query=get-rdf.disc.org.rq > construct-rdf.disc.org.ttl
```

Next step: compare the two models.


