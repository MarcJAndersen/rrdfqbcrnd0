---
title: "Create Integrity Contraints SPARQL Queries from RDF data qubce definition"
author: "mja@statgroup.dk"
date: "`r Sys.Date()`"
---

# Preliminaries

When developing, the script is intented to run from the package root after the setup for development as defined in the README.md. 
```{r, results='asis', eval=FALSE}
knit(input="inst/data-raw/create-qb-IC-dataset.Rmd",
     output="inst/data-raw/create-qb-IC-dataset.md")
```

# R-code

IC-19 is two queries, so it is split into IC-19a and IC-19b: For IC-20
and IC-21 special handling are needed. The queries are templates and
the value of p should be inserted as $p in the template.

```{r, results='asis', eval=TRUE}

library(RCurl)
library(XML)
library(devtools)

qbURL<-"http://www.w3.org/TR/2014/REC-vocab-data-cube-20140116/"
if (! url.exists(qbURL) ) {
  stop(paste0("Can not access URL ",qbURL))
}


# Acknowledgement: I got the approach from
# http://stackoverflow.com/questions/1395528/scraping-html-tables-into-r-data-frames-using-the-xml-package?lq=1

webpage <- getURL(qbURL)
# The following two lines is suggested in the stackoverflow post
# Apparantly not needed here
## Process escape characters
## webpage <- readLines(tc <- textConnection(webpage)); close(tc)

# Parse the html tree, ignoring errors on the page
pagetree <- htmlTreeParse(webpage, error=function(...){}, useInternalNodes = TRUE)

# appears that integrity checks starte with h3 and then a table with class bordered-table
# so that's what we look for
both<- getNodeSet(pagetree,"//*/h3[@id]|//*/table[@class='bordered-table']/tbody/tr/td/pre")


       irq20<- "
SELECT ?p WHERE {
    ?hierarchy a qb:HierarchicalCodeList ;
                 qb:parentChildProperty ?p .
    FILTER ( isIRI(?p) )
}
"

irq21<-"
SELECT ?p WHERE {
    ?hierarchy a qb:HierarchicalCodeList;
                 qb:parentChildProperty ?pcp .
    FILTER( isBlank(?pcp) )
    ?pcp  owl:inverseOf ?p .
    FILTER( isIRI(?p) )
}
"

qbIClist<- list()
storeIC<-function(ictitle,instantiationRq,rq) {
   return( list(HasInstantiation= nchar(instantiationRq)>0,
   ictitel= ictitle,
   instantiationRq= instantiationRq,
   rq= rq) )
  }

for (i in 1:(length(both)-1)) {
  icname<- xmlGetAttr(both[[i]],"id",default="none")
  if (grepl('ic-[1-9]([0-9])*', icname ) ) {
   ictitle<- xmlValue(xmlChildren(both[[i]])$text )
   rq<- paste0(xmlValue(xmlChildren(both[[i+1]])$text), sep="\n")
#   print(paste0( "Node ", i, ", IC name ", icname, " - ", ictitle ))
   if (icname %in% "ic-19") {
     ## XXX change list to vection - use unlist ??
      rq<- paste0((xmlValue(xmlChildren(both[[i+1]])$text))[1:8], sep="\n")
      qbIClist[["ic-19a"]]<- storeIC(gsub("IC-19", "IC-19a", ictitle), "", rq)
      rq<- paste0((xmlValue(xmlChildren(both[[i+1]])$text))[10:17], sep="\n")
      qbIClist[["ic-19b"]]<- storeIC(gsub("IC-19", "IC-19b", ictitle), "", rq)
     } else if ( icname == "ic-20" ) {
       qbIClist[[icname]]<- storeIC( ictitle, irq20, rq)
     } else if ( icname == "ic-21" ) {
       qbIClist[[icname]]<- storeIC( ictitle, irq21, rq)
     } else {
       qbIClist[[icname]]<- storeIC( ictitle, "", rq)
   }
  }
  }

```


```{r, results='asis', eval=TRUE}
qbIClist$`ic-19a`<- gsub("IC-19", "IC-19a", paste(unlist(strsplit(qbIClist$`ic-19`,"\n"))[1:9],collapse="\n"))

qbIClist$`ic-19b`<- gsub("IC-19", "IC-19b", paste(unlist(strsplit(qbIClist$`ic-19`,"\n"))[c(1,11:18)],collapse="\n"))
qbIClist$`ic-19`<- NULL
```

Here are the integrity constraints:
```{r, results='asis', eval=TRUE}
for (icname in names(qbIClist)) {
##    fileConn<-file(paste0(icname, ".rq"))
    cat( qbIClist[[icname]] )
##    close(fileConn)
  }
```

Data are stored in the data directory, following [R packages by Hadley Wickham](http://r-pkgs.had.co.nz/data.html) and [Writing R Extensions](http://cran.r-project.org/doc/manuals/R-exts.pdf).

knit runs the script in the data-raw directory, so it would be
expected to use pkg="../.." to store the qbIClist in the data directory
However, it did not work - hence the setwd below-
```{r, results='asis', eval=FALSE}
devtools::use_data(qbIClist,pgk="../..",overwrite=TRUE)
```

```{r, results='asis', eval=TRUE}

# This stores the qbIClist in the data directory
# Consider making it internal

devtools::use_data(qbIClist,overwrite=TRUE)

print("Done")

```
