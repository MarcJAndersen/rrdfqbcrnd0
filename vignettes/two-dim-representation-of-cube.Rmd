---
title: "Two dimensional representation of RDF data cube"
author: "PhuseSubTeamAnalysisResults@example.org"
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{Two dimensional representation of RDF data cube}
  %\VignetteEngine{knitr::knitr}
  %\usepackage[utf8]{inputenc}
  %\SweaveUTF8
---

# Setup

First load the package.
```{r, eval=TRUE}
library(rrdfqbcrnd0)
```

# Generating RDF data cube from specification in a spreadsheet and export as turtle file

The generation of RDF data cube can be specified in a spreadsheet.

## DM data 
The outputs below shows the generation of the DM RDF data cube.

```{r, eval=TRUE}
RDFCubeWorkbook<- system.file("extdata/sample-cfg", "RDFCubeWorkbook.xlsx", package="rrdfqbcrnd0")
dm.cube.fn<- BuildCubeFromWorkbook(RDFCubeWorkbook, "DM" )
cat("DM cube stored as ", dm.cube.fn, "\n")
```

## DEMO data 
The outputs below shows the generation of the DEMO RDF data cube.


```{r, eval=TRUE}
RDFCubeWorkbook<- system.file("extdata/sample-cfg", "RDFCubeWorkbook.xlsx", package="rrdfqbcrnd0")
demo.cube.fn<- BuildCubeFromWorkbook(RDFCubeWorkbook, "DEMO" )
cat("DEMO cube stored as ", demo.cube.fn, "\n")

dataCubeFile<- demo.cube.fn
checkCube <- new.rdf()  # Initialize
load.rdf(dataCubeFile, format="TURTLE", appendTo= checkCube)
summarize.rdf(checkCube)

dsdName<- GetDsdNameFromCube( checkCube )
domainName<- GetDomainNameFromCube( checkCube )
forsparqlprefix<- GetForSparqlPrefix( domainName )
```

View observation "ds:obs7"

```{r, eval=TRUE}
observations.rq<-  paste( forsparqlprefix,
'
select *
where { 
?s a qb:Observation ; 
?p ?o .
values (?s) {
(ds:obs7)
}
}
limit 30
',
"\n"                               
)

cube.observations<- sparql.rdf(checkCube, cube.observations.rq)
knitr::kable(cube.observations)

```


## Current - 10-mar-2015

```{r, echo=TRUE}
cols.rq<-  paste( forsparqlprefix,
'
select distinct ?colno ?cellpartno
where { 
?s a qb:Observation ; 
crnd-attribute:colno ?colno ;
crnd-attribute:cellpartno ?cellpartno .
}
order by ?colno ?cellpartno
',
"\n"                               
)

cols<- sparql.rdf(checkCube, cols.rq)
knitr::kable(cols)

dimensions<- sparql.rdf(checkCube, GetDimensionsSparqlQuery( forsparqlprefix ) )
attributesDf<- sparql.rdf(checkCube, GetAttributesSparqlQuery( forsparqlprefix ))

## rowdim<- setdiff(union(dimensions,attributesDf), c("crnd-dimension:saffl"))
## rowdim<- union(dimensions,attributesDf), c("crnd-dimension:saffl")

## rowdim<- c("crnd-dimension:saffl", "crnd-dimension:race", "crnd-dimension:sex", "crnd-dimension:factor",
## "crnd-dimension:procedure", "crnd-attribute:unit", "crnd-dimension:denominator" )

rowdim<- c("crnd-attribute:rowno", "crnd-dimension:agegr1", "crnd-dimension:race", "crnd-dimension:ethnic", "crnd-dimension:sex" )

coldim<- c("crnd-attribute:colno", "crnd-attribute:cellpartno", "crnd-dimension:trt01a", "crnd-dimension:procedure", "crnd-attribute:unit", "crnd-dimension:denominator" )
coldim<- c("crnd-attribute:colno", "crnd-attribute:cellpartno", "crnd-dimension:trt01a" )

qbtest<- GetTwoDimTableFromQb( checkCube, forsparqlprefix, domainName, rowdim, coldim )

qbtest
names(attributes(qbtest))
options(width=200)
knitr::kable(qbtest[order(strtoi(qbtest$rowno)),])

oDx<-attr(qbtest,"observationsDesc")
oDxx<- oDx[! is.na(oDx$s),]
oD<- oDxx[order(strtoi(oDxx$rowno)),]
presrowvarindex<- unique(oD$rowno)
colvarindex<- unique(oD$colno)
cellpartnoindex<- unique(oD$cellpartno)
presrowvarindex
colvarindex
cellpartnoindex
oD[,c("s","rowno","colno","cellpartno")]

presrowvarvalue<- gsub("crnd-dimension:|crnd-attribute:|crnd-measure:(.*)","\\1value",rowdim)
presrowvarIRI<- gsub("crnd-dimension:|crnd-attribute:|crnd-measure:(.*)","\\1IRI",rowdim)
presrowvarlabel<- gsub("crnd-dimension:|crnd-attribute:|crnd-measure:(.*)","\\1label",rowdim)

## add code for embedding the cube as turtle
## determine cube compontents except observations,
## as the observations are stored as RDFa
file<- file.path(system.file("extdata/sample-cfg", package="rrdfqbcrnd0"), "test.html")
# file<- file.path(tempdir(),"test.html")
append<- TRUE
print(file)
cat("<!DOCTYPE HTML>\n", file=file, append=FALSE)
cat('
<html>
  <head>
<meta charset="UTF-8">
<title>DEMO table as html</title>
   <script src="jquery-2.1.3.min.js"></script>
   <link rel="stylesheet" href="jquery-ui-1.11.3.custom/jquery-ui.css"/>
   <script src="jquery-ui-1.11.3.custom/jquery-ui.min.js"></script>
   <script src="RDFa.min.1.4.0.js"></script>

<style>
#table {
    line-height:30px;
    background-color:#eeeeee;
    height:1000px;
    width:750px;
    float:left;
    padding:5px;
}
#drop{
    width:300px;
    float:left;
    padding:10px;
}
</style>

</head>
<script>
"use strict";

function allowDrop(ev)
{
ev.preventDefault();
}

function drag(ev)
{
ev.dataTransfer.setData("Text",ev.target.id);
console.log("Dragging: ", ev.target.id);
}

function drop(ev)
{
ev.preventDefault();
var data=ev.dataTransfer.getData("Text");
console.log("Dropping: ", data);
ev.target.appendChild(document.getElementById(data));
}

$(document).ready(function(){

GreenTurtle.attach(document)

})
                  
</script>
<body>
<h1>DEMO table as RDFa</h1>
'
, file=file, append=TRUE)

cat('<div id="container">', file=file, append=TRUE)

cat("<div id='table'>\n", file=file, append=TRUE)
cat("<table border>\n", file=file, append=TRUE)
or<-1

## make the header row(s) for the columns

for (rr in presrowvarindex) {
  cat("<tr>", file=file, append=TRUE)
print(rr)
  ## make the row identification
  for (cc in colvarindex) {
print(cc)
    cat("<td>", file=file, append=TRUE)
cpindex<-0
    for (cp in cellpartnoindex) {
print(cp)
cpindex<- cpindex+1
if (cpindex>1) {
## separator between cells should be taken from data
      cat(" ", file=file, append=TRUE)
}
    if (oD$rowno[or]==rr & oD$colno[or]==cc & oD$cellpartno[or]==cp ) {
## The observation
      ## next line is for simple fly-over
      cat(paste0("<a title=\"", oD$measureIRI[or], "\">"), file=file, append=TRUE)

      cat(paste0('<span ', 'id="', gsub("ds:","",oD$s[or]), '"',
                 'resource="', oD$s[or],'"',
                 ' typeof="qb:Observation" draggable="true" ondragstart="drag(event)" >'),
          file=file, append=TRUE)
cat(paste0('<span property="qb:dataSet" resource="', 'ds:', dsdName,'">'), file=file, append=TRUE)
      
for (prop in dimensions) {
cat( paste0('<span property="', prop, '"', ' resource="', oD[or, gsub("crnd-dimension:|crnd-attribute:|crnd-measure:", "", prop)], '">'), file=file, append=TRUE)
}

## formatting to applied to measure
      cat(paste0(oD$measure[or]), file=file, append=TRUE)

for (prop in dimensions) {
cat( '</span>', file=file, append=TRUE)
}
cat( '</span>', file=file, append=TRUE)
cat( '</span>', file=file, append=TRUE)

      cat(paste0("</a>"), file=file, append=TRUE)
      or<- or+1
    }
    }
    cat("</td>", file=file, append=TRUE)
  }
cat("</tr>", file=file, append=TRUE)
  }
cat("</table>\n", file=file, append=TRUE)
cat("</div>\n", file=file, append=TRUE)

cat('
<div id="drop">
Drag and drop a row to here.
<table>
<tr><td>
<span  style="width:100px" id="div1" ondrop="drop(event)" ondragover="allowDrop(event)">Got it</span>
</td></tr>
</table>
</div> 
',  file=file, append=TRUE)                 
cat('
</div>
</body>
</html>
', file=file, append=TRUE)
print(file)

```

## Create the two dimensional representation

For sex, race and factor show the label and the level if the level is not _ALL_.
If factor is code:factor-AGE then show the label.
Allocate 1 rightmost columns for the procedure.
Allocate 1 rightmost columns for unit, show it if not _NULL_.

```{r, echo=TRUE}
dimensions<- sparql.rdf(checkCube, GetDimensionsSparqlQuery( forsparqlprefix ) )
attributesDf<- sparql.rdf(checkCube, GetAttributesSparqlQuery( forsparqlprefix ))

rowdim<- c("crnd-dimension:agegr1", "crnd-dimension:race", "crnd-dimension:ethnic", "crnd-dimension:sex", "crnd-dimension:factor",
"crnd-dimension:procedure", "crnd-attribute:unit", "crnd-dimension:denominator" )

coldim<- c("crnd-dimension:trt01a")

qbtest<- GetTwoDimTableFromQb( checkCube, forsparqlprefix, domainName, rowdim, coldim )

qbtest
names(attributes(qbtest))

## attr(qbtest,"obsURI")

## show the data frame with measures for observations and dimensions and attributes
qbtest
## show the rowLabel dataset
rowLabel<- attr(qbtest,"rowLabelDf")
rowLabel
prColspan<- data.frame( unit=integer(nrow(qbtest)), proc=integer(nrow(qbtest)), idcol1= integer(nrow(qbtest)), stringsAsFactors=FALSE  )
prIdCol<- data.frame( procedurevalue=character(nrow(qbtest)), unitvalue=character(nrow(qbtest)), stringsAsFactors=FALSE )
rowno<-5
rowid<- rowdim[1]
## travers all values to determine number of identification columns
Nidcol<- 1
for (rowno in 1:nrow(qbtest)) {
  prIdCol$procedurevalue[rowno]<- rowLabel$value[ rowLabel$codeval==qbtest$procedure[rowno] ]
  prIdCol$unitvalue[rowno]<- qbtest$unit[rowno]
  currNidcol<-0
  if (qbtest$factor[rowno] %in% c("code:factor-proportion", "code:factor-quantity") ) {
     for (rowid in setdiff(rowdim,c("crnd-dimension:procedure","crnd-attribute:unit", "crnd-dimension:denominator"))) {
       currRowLabel<- rowLabel$variable==gsub("crnd-dimension:|crnd-attribute:|crnd-measure:", "", rowid) & rowLabel$codeval==qbtest[rowno,gsub("crnd-dimension:|crnd-attribute:|crnd-measure:", "", rowid)]
       if ( rowLabel$value[ currRowLabel ] != "_ALL_" ) {
         currNidcol<- currNidcol+1
         prIdCol[rowno, paste0("idcollabel",currNidcol ) ]<- rowLabel$label[ currRowLabel ]
         prIdCol[rowno, paste0("idcolvalue",currNidcol ) ]<- rowLabel$value[ currRowLabel ]
       }
     }
     }
    else {
      for (rowid in setdiff(rowdim,c("crnd-dimension:procedure","crnd-attribute:unit", "crnd-dimension:denominator"))) {
        currRowLabel<- rowLabel$variable==gsub("crnd-dimension:|crnd-attribute:|crnd-measure:", "", rowid) & rowLabel$codeval==qbtest[rowno,gsub("crnd-dimension:|crnd-attribute:|crnd-measure:", "", rowid)]
        if ( rowLabel$value[ currRowLabel ] != "_ALL_" ) {
          currNidcol<- currNidcol+1
          ## XX for now only descriptive statistics
          prIdCol[rowno, paste0("idcollabel",currNidcol ) ]<- rowLabel$value[ currRowLabel ]
          prIdCol[rowno, paste0("idcolvalue",currNidcol ) ]<- " "
        }
      }
    }
     Nidcol<- max( Nidcol, currNidcol )
   }
  
pr2IdCol<-   prIdCol[,c(paste0("idcolvalue",1:Nidcol),"procedurevalue", "unitvalue")]
pr2IdCol

rowdisplay<- c( "crnd-dimension:sex", "crnd-dimension:race", "crnd-dimension:factor",  "crnd-dimension:procedure",  "crnd-attribute:unit", "crnd-dimension:denominator")

presTable<- qbtest
colnoseq<- attr(qbtest,"colnoseq")
rownoseq<- attr(qbtest,"rownoseq")
observationsDesc<-attr(qbtest,"observationsDesc")
for (colno in colnoseq) {
   presTable[,paste0("col", colno)]<- rep( NA, length(rownoseq))
 }
for (colno in colnoseq) {
   for (rowno in rownoseq) {
     presTable[rowno,paste0("col", colno)]<- observationsDesc[observationsDesc$rowno==rowno & observationsDesc$colno==colno, "measure"]
}
}

presTable

```

Approach for making html code see library(Hmisc), html.data.frame.
To make the usual N, % - introduce a new attibute sub column with 1 for N and 2 for %, 1 for all other statistics. Then the table can be made by defining columns from TRT01A and sub column.

```{r, echo=TRUE}
colLabel<- attr(qbtest,"colLabelDf")
colLabel
options(width=300)
file<- file.path(system.file("extdata/sample-cfg", package="rrdfqbcrnd0"), "test.html")
# file<- file.path(tempdir(),"test.html")
append<- TRUE
print(file)
oD<-attr(qbtest,"observationsDesc")
names(oD)
cat("<!DOCTYPE HTML>\n", file=file, append=FALSE)
cat('
<html>
<head>
<meta charset="UTF-8">
<title>DEMO table as html</title>
   <link rel="stylesheet" href="jquery-ui-1.11.3.custom/jquery-ui.css"/>
   <script src="jquery-2.1.3.min.js"></script>
   <script src="jquery-ui-1.11.3.custom/jquery-ui.min.js"></script>
   <script src="RDFa.min.1.4.0.js"></script>
</head>
<script>
"use strict";

function allowDrop(ev)
{
ev.preventDefault();
}

function drag(ev)
{
ev.dataTransfer.setData("Text",ev.target.id);
console.log("Dragging: ", ev.target.id);
}

function drop(ev)
{
ev.preventDefault();
var data=ev.dataTransfer.getData("Text");
console.log("Dropping: ", data);
ev.target.appendChild(document.getElementById(data));
}
</script>
<body>
<h1>DEMO table as RDFa</h1>
'
, file=file, append=TRUE)

cat("<table border>\n", file=file, append=TRUE)
or<-1
## unique(oD$rowno)
## unique(oD$colno)
presrowvarvalue<- gsub("crnd-dimension:|crnd-attribute:|crnd-measure:(.*)","\\1value",rowdim)
presrowvarIRI<- gsub("crnd-dimension:|crnd-attribute:|crnd-measure:(.*)","\\1IRI",rowdim)
presrowvarlabel<- gsub("crnd-dimension:|crnd-attribute:|crnd-measure:(.*)","\\1label",rowdim)
presrowvarindex<- 1:length(rowdim)
## make the header row(s) for the columns
## TODO the code below does only work for this special case
cat("<tr>", file=file, append=TRUE)
for (vi in presrowvarindex) {
    cat("<th>", file=file, append=TRUE)
      ## next line is for simple fly-over
      cat(paste0("<a title=\"", oD[1, presrowvarIRI[vi]], "\">", oD[or,presrowvarlabel[vi]], "</a>"), file=file, append=TRUE)
    cat("</th>", file=file, append=TRUE)
    }
  for (cc in unique(oD$colno)) {
    cat("<th>", file=file, append=TRUE)
      cat(paste0("<a title=\"", colLabel$codeval[cc], "\">", colLabel$value[cc], "</a>"), file=file, append=TRUE)
      }
    cat("</th>", file=file, append=TRUE)

cat("</tr>", file=file, append=TRUE)
for (rr in unique(oD$rowno)) {
  cat("<tr>", file=file, append=TRUE)
  ## make the row identification
  for (vi in presrowvarindex) {
    cat("<td>", file=file, append=TRUE)
      ## next line is for simple fly-over
      cat(paste0("<a title=\"", oD[or, presrowvarIRI[vi]], "\">", oD[or,presrowvarvalue[vi]], "</a>"), file=file, append=TRUE)
    cat("</td>", file=file, append=TRUE)
    }
  for (cc in unique(oD$colno)) {
    ## assign to cell id="obs11" class="showrow"
    cat("<td>", file=file, append=TRUE)
    if (oD$rowno[or]==rr & oD$colno[or]==cc) {
## The observation
      
      ## next line is for simple fly-over
      cat(paste0("<a title=\"", oD$measureIRI[or], "\">"), file=file, append=TRUE)

      cat(paste0('<span resource="', oD$s[or],'"',
                 ' typeof="qb:Observation" draggable="true" ondragstart="drag(event)" >'),
          file=file, append=TRUE)
cat(paste0('<span property="qb:dataSet" resource="', 'ds:', dsdName,'">'), file=file, append=TRUE)
      
for (prop in dimensions) {
cat( paste0('<span property="', prop, '"', ' resource="', oD[or, gsub("crnd-dimension:|crnd-attribute:|crnd-measure:", "", prop)], '">'), file=file, append=TRUE)
}
      cat(paste0(oD$measure[or]), file=file, append=TRUE)

for (prop in dimensions) {
cat( '</span>', file=file, append=TRUE)
}
cat( '</span>', file=file, append=TRUE)
cat( '</span>', file=file, append=TRUE)

      cat(paste0("</a>"), file=file, append=TRUE)
      or<- or+1
      }
    cat("</td>", file=file, append=TRUE)
  }
cat("</tr>", file=file, append=TRUE)
  }
cat("</table>\n", file=file, append=TRUE)
cat('
</body>
</html>
', file=file, append=TRUE)
print(file)

```

To get it working with the scripts and links above:

ln -s ~/packages/green-turtle/build/RDFa.min.1.4.0.js 
ln -s ~/packages/green-turtle/build/RDFaProcessor.min.1.4.0.js 
ln -s ~/packages/jquery-2.1.3.min/jquery-2.1.3.min.js .
ln -s ~/packages/jquery-ui-1.11.3.custom .

# Session information
```{r, echo=TRUE}
sessionInfo()
```

