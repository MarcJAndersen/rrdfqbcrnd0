---
title: "AE table from CSV file"
author: "PhuseSubTeamAnalysisResults@example.org"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AE table from CSV file}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---


### How to run from command prompt when developing

Start in the package root directory

Devtools should reply reply Loading rrdfqbcrnd0.

The knit command should generate .md file in the present work directory - the package root directory


```{r, eval=FALSE}
library(devtools)
devtools::load_all()

library(knitr)
knit("vignettes/ae-table-from-csv.Rmd")
```

Generate the pdf file using the following command
```{r makepdf.sh, eval=FALSE, engine='bash'}
pandoc ae-table-from-csv.md -o xx.pdf
```

The knitr::knit2html should generate a .html file in the present work directory - the package root directory

Generating HTML works nicely
```{r, eval=FALSE} 
knitr::knit2html("vignettes/ae-table-from-csv.Rmd")
```

## Code


```{r, results='asis', eval=TRUE}

library (rrdf)
library(rrdfqbcrnd0)


#------------  Declarations    ------------------------------------------------
endpoint<- "http://localhost:3030/cdisc/query"

endpoint<- NULL # use internal version

cubeVersion <- "0-5-2"  # For pav:Version (dot, notdash) and output file name

# dataDir <- "."  # Directory for output files

dataDir <- tempdir()  # Directory for output files


generalprefixSourceFile<- system.file("extdata/sample-cfg", "CommonCubePrefixes.csv", package="rrdfqbcrnd0")
if (! file.exists(generalprefixSourceFile) ) {
  # consider using try instead
  stop( paste0("Expected file ", generalprefixSourceFile, " does not exist" ))
  }
specificprefixSourceFile<- system.file("extdata/sample-cfg", "AECubePrefixes.csv", package="rrdfqbcrnd0")
if (! file.exists(specificprefixSourceFile) ) {
  # consider using try instead
  stop( paste0("Expected file ", specificprefixSourceFile, " does not exist" ))
  }

generalprefixSource = read.csv(generalprefixSourceFile) 
specificprefixSource= read.csv(specificprefixSourceFile)
prefixSource= rbind(generalprefixSource, specificprefixSource)

AEskeletonSourceFile <- system.file("extdata/sample-cfg", "skeletonSource-AE.csv", package="rrdfqbcrnd0")

AEdsdName <- "dsd-ae"

# Cube Observation data       
AEobsFileName<- system.file("extdata/sample-cfg", "ae.AR.csv", package="rrdfqbcrnd0")
if (! file.exists(AEobsFileName) ) {
  # consider using try instead
  stop( paste0("Expected file ", AEobsFileName, " does not exist" ))
  }


# These codelist could also go in a RDF codelists instead of CSV files
AE.recode.aesoc.list<- read.csv(file=system.file("extdata/sample-cfg", "ae.aesoc.AR.csv", package="rrdfqbcrnd0"))
aesoc.list= list();
for (i in 1:nrow(AE.recode.aesoc.list)) {
  aesoc.list[[ as.character(AE.recode.aesoc.list[i,1]) ]]=
       encodetouri( paste0("aesoc-",as.character(AE.recode.aesoc.list[i,2])) )
}

AE.recode.aedecod.list<- read.csv(file=system.file("extdata/sample-cfg", "ae.aedecod.AR.csv", package="rrdfqbcrnd0"))
aedecod.list= list();
for (i in 1:nrow(AE.recode.aedecod.list)) {
  aedecod.list[[ as.character(AE.recode.aedecod.list[i,1]) ]]= encodetouri( paste0("aedecod-",as.character(AE.recode.aedecod.list[i,2])) )
}



AE.recode.list= list(
    "saffl"=list('Y'='saffl-Y',
                        'N'='saffl-N',
                        '_ALL_'='saffl-_ALL_'),
    "trta"=list('Placebo'='trta-Placebo',
                         'Xanomeline High Dose'='trta-Xanomeline_High_Dose',
                         'Xanomeline Low Dose'='trta-Xanomeline_Low_Dose',
                         '_ALL_'='trta-_ALL_' ),
    "aesoc"=aesoc.list,
    "aedecod"=aedecod.list,
    "factor"=list('quantity'='factor-QUANTITY',
                         'proportion'='factor-PROPORTION', 
                         'AGE'='factor-AGE',
      'USUBJID'='factor-USUBJID'
      ),
    "procedure"= list('count'='procedure-COUNT',
      'countdistinct'='procedure-COUNTDISTINCT',
                            'percent'='procedure-PERCENT', 
                            'mean'='procedure-MEAN', 
                            'stdev'='procedure-STDDEV', 
                            'min'='procedure-MIN', 
                            'median'='procedure-MEDIAN', 
                            'max'='procedure-MAX' )
  )

  procedure2format= list("count"="int",
                         "countdistinct"="int",
                            'percent'='double', 
                            'mean'='double', 
                            'stdev'='double', 
                            'min'='double', 
                            'median'='double', 
                            'max'='double'                         

     );



AEdataCubeFileName  <- paste0("DC-AE-R-V-",cubeVersion,".TTL")   
AEdataCubeFile      <- file.path(dataDir,AEdataCubeFileName) # Full path to cube
  
storeAE = new.rdf(ontology=FALSE)  # Initialize

AEprefixlist= qb.def.prefixlist(storeAE, prefixSource)

AEskeletonSource = read.csv(AEskeletonSourceFile) 

AEobsData = read.csv(AEobsFileName) 
names(AEobsData)= tolower(names(AEobsData))


qb.buildSkeleton(storeAE, AEprefixlist, AEobsData, AEskeletonSource)

qb.buildDSD(storeAE, AEprefixlist, AEobsData, AEskeletonSource,
            dsdURIwoprefix="dataset-ae",
            dsdName=AEdsdName,
            extra=list(description="Cube with XX dimensions and 1 measure (measure)",
comment="Adverse event sample table ",
label="Adverse events results data set.",
distribution=AEdataCubeFileName,
obsfilename=AEobsFileName,
title="Adverse Event Analysis Results"
 ),
remote.endpoint=endpoint
            )

qb.buildObservations( store=storeAE, prefixlist=AEprefixlist, obsData=AEobsData, skeletonSource=AEskeletonSource, dsdURIwoprefix="dataset-ae", recode.list=AE.recode.list, procedure2format=procedure2format )

##########
# Output #
###############################################################################
AEoutcube = save.rdf(storeAE, filename=AEdataCubeFile, format="TURTLE")
print(paste0("Wrote file ", AEoutcube, " to ", AEdataCubeFile ))

```


Now look at the cube. 

Note: by specifying prefix the output is shown using the prefixes.

Note for future: This may be a disadvantage if the value of the prefix, say ds, changes.

```{r, echo=FALSE, results='asis'}

checkAE = new.rdf(ontology=FALSE)  # Initialize
load.rdf( AEdataCubeFile, format="TURTLE", appendTo= checkAE)
summarize.rdf(checkAE)


## ------------------------------------------------------------------------

myprefixes= c( qbCDISCprefixes,
  list(
 "dccs"="http://www.example.org/dc/ae/dccs/" ,
 "code"="http://www.example.org/dc/code/" ,
 "ds"=  "http://www.example.org/dc/ae/dataset/" ,
 "prop"="http://www.example.org/dc/ae/prop/",
 "valid"="http://www.example.org/dc/ae/valid/"
)  )


forsparqlprefix= paste("prefix", paste(names(myprefixes),":",sep=""), paste("<",myprefixes,">",sep=""),sep=" ",collapse=" ")

cube.observations1= sparql.rdf(checkAE,
   paste( forsparqlprefix,
     "select * where {?s ?p ?o .} limit 10"
     )
   );
knitr::kable(head(cube.observations1, 10))


cube.observations2= sparql.rdf(checkAE,
   paste( forsparqlprefix,
     "select * where { ?s a qb:Observation ; ?p ?o .}"
     )
   );
knitr::kable(head(cube.observations2, 10))
```
